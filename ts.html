<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진동 감지 및 데시벨 측정</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        canvas {
            width: 100%;
            height: 200px;
            border: 1px solid black;
        }
        #status {
            margin-top: 20px;
            font-size: 18px;
        }
        #vibrationValue, #dbValue {
            margin-top: 20px;
            font-size: 18px;
        }
        .data-list {
            margin-top: 20px;
            text-align: left;
            font-size: 16px;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<h1>진동 감지 및 데시벨 측정</h1>
<p>핸드폰의 가속도 센서와 마이크를 통해 진동과 데시벨을 감지하고, 결과를 그래프로 시각화합니다.</p>

<h2>진동 감지</h2>
<canvas id="vibrationCanvas"></canvas>
<p id="vibrationValue">진동 세기: 0</p>

<h2>데시벨 측정</h2>
<canvas id="dbCanvas"></canvas>
<p id="dbValue">데시벨: 0 dB</p>

<div class="data-list">
    <h3>기록된 진동 값</h3>
    <ul id="vibrationDataList"></ul>
    <h3>기록된 데시벨 값</h3>
    <ul id="dbDataList"></ul>
</div>

<p id="status">상태: 대기 중...</p>

<!-- 데이터 전달 페이지 -->
<a href="tl.html">데이터 페이지로 이동</a>

<script src="soundAnalysis.js"></script>

<script>
    // 진동 값과 데시벨 값을 localStorage에 저장하는 코드
    function saveData(vibrationValue, dbValue) {
        localStorage.setItem("vibrationValue", vibrationValue);
        localStorage.setItem("dbValue", dbValue);
    }

    // 진동 감지
    let vibrationValue = 0;
    window.addEventListener('devicemotion', function(event) {
        let x = event.acceleration.x;
        let y = event.acceleration.y;
        let z = event.acceleration.z;
        // 진동 세기는 가속도 변화량으로 계산
        vibrationValue = Math.sqrt(x*x + y*y + z*z);
        document.getElementById('vibrationValue').textContent = "진동 세기: " + vibrationValue.toFixed(2);
        
        // 진동 값을 canvas에 그래프화
        drawVibrationGraph(vibrationValue);
        
        // 진동 값 저장
        saveData(vibrationValue, dbValue);
    });

    // 데시벨 측정
    let dbValue = 0;
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let analyser = audioContext.createAnalyser();
    let microphone;
    
    navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        analyser.fftSize = 256;
        let bufferLength = analyser.frequencyBinCount;
        let dataArray = new Uint8Array(bufferLength);
        
        function updateDecibels() {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            dbValue = sum / bufferLength;
            document.getElementById('dbValue').textContent = "데시벨: " + dbValue.toFixed(2) + " dB";
            
            // 데시벨 값을 canvas에 그래프화
            drawDbGraph(dbValue);

            // 데시벨 값 저장
            saveData(vibrationValue, dbValue);
            requestAnimationFrame(updateDecibels);
        }
        
        updateDecibels();
    }).catch(function(err) {
        console.error("마이크를 사용할 수 없습니다: " + err);
    });

    // 진동 값 그래프 그리기
    function drawVibrationGraph(vibrationValue) {
        let canvas = document.getElementById('vibrationCanvas');
        let ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.beginPath();
        ctx.moveTo(0, canvas.height - vibrationValue * 10);
        ctx.lineTo(canvas.width, canvas.height - vibrationValue * 10);
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // 데시벨 값 그래프 그리기
    function drawDbGraph(dbValue) {
        let canvas = document.getElementById('dbCanvas');
        let ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.beginPath();
        ctx.moveTo(0, canvas.height - dbValue);
        ctx.lineTo(canvas.width, canvas.height - dbValue);
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    // 상태 업데이트
    document.getElementById('status').textContent = "상태: 측정 중...";
</script>

</body>
</html>
