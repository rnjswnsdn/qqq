<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진동 및 데시벨 감지</title>
</head>
<body>
    <h1>진동 및 데시벨 감지</h1>
    <p>현재 데시벨: <span id="decibel">0</span> dB</p>
    <p>진동 감지: <span id="vibration">No</span></p>
    <button onclick="viewRecords()">측정 기록 보기</button>

    <script>
        // 데시벨 감지 (Web Audio API)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function detectDecibel() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const averageDecibel = sum / bufferLength;

                // 데시벨이 기준(50 dB)을 넘으면 기록
                if (averageDecibel > 50) {
                    localStorage.setItem('decibelRecord', JSON.stringify({ time: new Date(), decibel: averageDecibel }));
                }

                document.getElementById('decibel').textContent = averageDecibel.toFixed(2);
                requestAnimationFrame(detectDecibel);
            }

            detectDecibel();
        });

        // 진동 감지 (DeviceMotionEvent)
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', event => {
                const acceleration = event.acceleration;
                const vibrationDetected = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2) > 10;

                if (vibrationDetected) {
                    localStorage.setItem('vibrationRecord', JSON.stringify({ time: new Date(), vibration: 'Detected' }));
                }

                document.getElementById('vibration').textContent = vibrationDetected ? 'Yes' : 'No';
            });
        } else {
            alert("이 디바이스는 진동 감지를 지원하지 않습니다.");
        }

        // 측정 기록 보기
        function viewRecords() {
            window.location.href = "records.html"; // 기록 페이지로 이동
        }
    </script>
</body>
</html>
